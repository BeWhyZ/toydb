# Tests ROLLBACK.

> CREATE TABLE test (id INT PRIMARY KEY, value STRING)
---
ok

# A rollback removes the row, TxnActive record and its TxnWrite records.
[ops,result]> BEGIN
[ops,result]> INSERT INTO test VALUES (1, 'a'), (2, 'b')
[ops,result]> ROLLBACK
---
v2 read-write active={}
storage set mvcc:NextVersion → 3 ["\x00" → "\x03"]
storage set mvcc:TxnActive(2) → "" ["\x01\x00\x00\x00\x00\x00\x00\x00\x02" → ""]
Insert { count: 2 }
storage set mvcc:TxnWrite(2, sql:Row(test, 1)) → "" ["\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00" → ""]
storage set mvcc:Version(sql:Row(test, 1), 2) → 1,'a' ["\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02" → "\x01\x06\x02\x02\x02\x04\x01a"]
storage set mvcc:TxnWrite(2, sql:Row(test, 2)) → "" ["\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00" → ""]
storage set mvcc:Version(sql:Row(test, 2), 2) → 2,'b' ["\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02" → "\x01\x06\x02\x02\x04\x04\x01b"]
Rollback { version: 2 }
storage delete mvcc:Version(sql:Row(test, 1), 2) ["\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02"]
storage delete mvcc:TxnWrite(2, sql:Row(test, 1)) ["\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00"]
storage delete mvcc:Version(sql:Row(test, 2), 2) ["\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02"]
storage delete mvcc:TxnWrite(2, sql:Row(test, 2)) ["\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00"]
storage delete mvcc:TxnActive(2) ["\x01\x00\x00\x00\x00\x00\x00\x00\x02"]

# A later transaction can't see its writes.
c1:> SELECT * FROM test
---
ok

# If there are concurrent transactions, it does not remove the
# TxnActiveSnapshot. This is needed for consistent AS OF queries.
c1:> BEGIN
---
ok

c2:[ops,result]> BEGIN
c2:[ops,result]> ROLLBACK
---
c2: v4 read-write active={3}
c2: storage set mvcc:NextVersion → 5 ["\x00" → "\x05"]
c2: storage set mvcc:TxnActiveSnapshot(4) → {3} ["\x02\x00\x00\x00\x00\x00\x00\x00\x04" → "\x01\x03"]
c2: storage set mvcc:TxnActive(4) → "" ["\x01\x00\x00\x00\x00\x00\x00\x00\x04" → ""]
c2: Rollback { version: 4 }
c2: storage delete mvcc:TxnActive(4) ["\x01\x00\x00\x00\x00\x00\x00\x00\x04"]

# Rollback errors when there's no open transaction.
!> ROLLBACK
---
Error: invalid input: not in a transaction
